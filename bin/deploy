#!/usr/bin/env ruby

require 'json'
require 'pp'
require 'slop'

def version
  @version ||= begin
    data = JSON.parse(File.read('./package.json'))
    data['version']
  end
end

opts = Slop.parse do |o|
  o.bool    '-s', '--stable', 'indicates that you are updating the stable version'
  o.string  '-e', '--environment' , 'indicates the desired environment you wish to deploy to', default: 'staging'
  o.on      '-v', '--version', 'prints current version of the SDK (for sanity check)' do
    puts "Current version is #{version}"
    exit
  end
end

def version_or_environment(opts)
  opts[:environment] == 'production' ? version : opts[:environment]
end

def execute(cmd)
  puts "\n***************************************************************************"
  puts "$ #{cmd}"
  system(cmd)
end

# Notes:
#
# To update a version
#   1. Update package.json
#   2. Update index.js - yeah, we copy it for now
#   3. Deploy
#
# We always build to the version folder under tools:
#   cdn.translationexchange.com/tools/tml/${version}/tml.js
#   cdn.translationexchange.com/tools/tml/${version}/tml.min.js
#
# Optionally, if you say so, we will build under latest:
#   cdn.translationexchange.com/tools/tml/latest/tml.js
#   cdn.translationexchange.com/tools/tml/latest/tml.min.js
#
# If you must make changes to older versions:
#   1. branch it from that version:  git checkout -b 0.1.0 0.1.0
#   2. make changes you want and cherry pick them back to develop (or the other way around)
#   3. run deploy script from the branch - it will update the appropriate version


puts "Deploying current dist/tml-#{version}.js as tools/tml/#{version_or_environment(opts)}/tml.js ...\n\n"

execute('(grunt build)')
execute("aws s3 cp dist/tml.js s3://trex-snapshots/tools/tml/#{version_or_environment(opts)}/tml.js")
execute("aws s3 cp dist/tml.min.js s3://trex-snapshots/tools/tml/#{version_or_environment(opts)}/tml.min.js")
execute("bin/invalidate tools/tml/#{version}/tml.js tools/tml/#{version_or_environment(opts)}/tml.min.js")

# only if you say so, update the stable release
if opts[:stable] and opts[:environment] == 'production'
  puts "Tagging current version as #{version}"
  execute("git tag #{version}")
  execute("git push")

  execute("aws s3 cp dist/tml.js s3://trex-snapshots/tools/tml/stable/tml.js")
  execute("aws s3 cp dist/tml.min.js s3://trex-snapshots/tools/tml/stable/tml.min.js")
  execute("bin/invalidate tools/tml/stable/tml.js tools/tml/stable/tml.min.js")
end

puts "\n\nCongratulations, the tml v#{version} has been deployed...\n\n"
